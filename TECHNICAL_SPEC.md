# Tattoo Suite Bot + Mini App — Technical Specification

## 1. Цель проекта
Создать систему “бот + Mini App” для тату-мастера/салона:
- клиент быстро получает расчёт стоимости, видит работы, записывается и (на этапе 3) оплачивает депозит/заказ;
- мастер/админ управляет расписанием, ценами, скидками, заявками и видит базовую статистику.

Ключевые принципы:
- MVP быстро приносит заявки и записи;
- логика отделена от хендлеров (тонкие хендлеры + сервисы + репозитории);
- админ-доступ безопасный (allowlist по telegram user_id);
- Mini App на этапе 2 — 2D overlay (3D вынесен в отдельный epic после валидации).


## 2. Роли и доступы
### 2.1 Клиент
- просмотр: главная, галерея, калькулятор;
- создание заявки/записи;
- получение уведомлений (подтверждение, напоминания).

### 2.2 Админ/мастер
- доступ к админ-панели: только для allowlist по telegram_user_id;
- управление:
  - рабочие дни/часы и исключения (выходные/отпуск/блок-слоты/доп-дни);
  - прайс-матрица (часть тела/размер/сложность) и коэффициенты;
  - скидки/промокоды;
  - работы/стили (галерея);
  - заявки/записи + статусы;
  - статистика/выручка.

⚠️ Примечание: username (ник) может меняться — не используется как ключ доступа.


## 3. Продуктовый флоу
### 3.1 Клиентский флоу (MVP, этап 1)
Меню:
- Главная
- Галерея
- Калькулятор
- Запись
- (везде) Назад

Сценарии:
1) Галерея → выбрать стиль → выбрать работу → “Хочу так же” → заявка/запись
2) Калькулятор → часть тела + размер + сложность → предварительная цена → “Записаться”
3) Запись → календарь (дата) → слоты (время) → подтверждение

Уведомления:
- “Запись создана/подтверждена”
- напоминание за 24 часа
- напоминание за 2 часа

#### Текущее состояние реализации (факт на Stage-1)
- `/start` показывает главное меню (reply keyboard).
- Запись (`Записаться на сеанс`) реализована как FSM-флоу из 2 сообщений:
  - верхнее: сводка заказа (inline-кнопки редактирования + `Сбросить заявку` + `В меню`)
  - нижнее: текущий вопрос/календарь/подтверждение
- Политика календаря/слотов сейчас фиксированная:
  - диапазон дат: `days_ahead=90` (включительно), расчёт по дате в `Europe/Moscow`
  - слоты времени: `12:00` .. `20:00` (каждый час, включительно), UI подписан как МСК
  - при сохранении запись конвертируется в UTC
- `Подтвердить` создаёт запись `Order` в базе (Postgres).

### 3.2 Админский флоу (MVP, этап 1)
- Админ-панель в боте появляется только админам (allowlist).
- Разделы:
  - Расписание (правила + исключения)
  - Прайс и коэффициенты (калькулятор)
  - Скидки/промо
  - Галерея (стили/работы)
  - Заявки/записи
  - Статистика (минимум)


## 4. Этапы разработки
### Этап 0 — Каркас проекта
Deliverables:
- структура репозитория, docker-compose, Poetry;
- Postgres + Alembic миграции;
- базовое логирование (структурно) + редактирование секретов/PII;
- CI: lint/format/tests;
- базовые интерфейсы сервисов/репозиториев.

Definition of Done:
- проект поднимается одной командой;
- тесты и линтеры проходят в CI;
- секреты не хранятся в репозитории.

### Этап 1 — Telegram Bot MVP
Функциональность клиента:
- меню + “назад”;
- галерея (стили → работы);
- калькулятор (часть тела + размер + сложность → цена);
- запись через календарь в боте;
- создание заявки/записи и подтверждение.

Функциональность админа:
- управление расписанием и исключениями;
- настройка прайс-матрицы и коэффициентов;
- скидки/промокоды (база);
- CRUD стилей/работ;
- обработка записей/заявок + статусы;
- базовая статистика (выручка/кол-во записей).

Техника:
- dev: polling
- prod: webhook
- Redis: FSM, rate limit, кэш
- Postgres: основное хранилище

Definition of Done:
- клиент может получить расчёт и записаться;
- админ может управлять расписанием/ценами/контентом;
- нет бизнес-логики в хендлерах, есть тесты на ключевую логику.

### Этап 2 — Mini App MVP (2D overlay)
Mini App:
- выбор зоны/части тела (шаблон);
- загрузка эскиза;
- масштабирование (в см) + позиционирование (drag);
- превью + сохранение результата;
- отправка результата в backend и возврат в бота.

Definition of Done:
- данные из Mini App корректно попадают в заявку/калькулятор;
- превью сохраняется и доступно в карточке заявки.

Примечание:
- 3D overlay/проекция — отдельный epic после валидации ценности.

### Этап 3 — Платежи + CRM
Платежи:
- абстракция PaymentProvider;
- создание инвойса / ссылки оплаты;
- приём webhooks, идемпотентность;
- статусы оплаты и отражение в записи.

CRM:
- расширение мини-CRM в боте либо добавление web-админки (если вырастает объём).

Definition of Done:
- платежи проходят и корректно меняют статусы;
- запись “confirmed” не ломается при повторных webhook.

### Этап 4 — Оптимизация и bug hunt
- нагрузочные тесты;
- security checklist + устранение рисков;
- стабилизация (таймауты/ретраи/ограничение параллелизма).

Definition of Done:
- воспроизводимая сборка, мониторинг ошибок, нет критических уязвимостей;
- ключевые сценарии устойчивы под нагрузкой.


## 5. Архитектура и принципы (SOLID)
Правило: handlers = только I/O и роутинг. Вся логика — в сервисах.

Рекомендуемая структура:
- apps/
  - bot/
    - handlers/
    - keyboards/
    - middlewares/
  - api/
    - routes/
    - schemas/
- core/
  - domain/            # сущности/правила/политики
  - services/          # use-cases
  - repositories/      # доступ к БД
- infra/
  - db/                # engine/session, migrations
  - redis/
  - logging/
  - payments/
- tests/
- docker-compose.yml
- pyproject.toml
- .env.example


## 6. Модель данных (черновик)
### 6.1 Users/Clients
- users:
  - telegram_user_id (unique)
  - username (optional)
  - role (admin/user)
- clients:
  - id
  - telegram_user_id (nullable)
  - name
  - phone / contact (optional)
  - notes

### 6.2 Gallery
- styles:
  - id
  - name
  - description
- works:
  - id
  - style_id (FK)
  - title
  - image_url or file_id
  - tags (json/array)

### 6.3 Pricing/Discounts
- pricing_rules:
  - id
  - body_part
  - size_min_cm
  - size_max_cm
  - complexity (enum)
  - base_price
  - multiplier
  - updated_at
- discounts:
  - id
  - type (promo/personal)
  - code (nullable)
  - value (percent/fixed)
  - conditions (json)
  - active

### 6.4 Schedule/Booking
- schedule_rules:
  - id
  - weekday (0-6)
  - start_time
  - end_time
  - slot_minutes
  - buffer_minutes
- schedule_exceptions:
  - id
  - date
  - type (off/extra/block)
  - start_time (nullable)
  - end_time (nullable)
  - reason
- appointments:
  - id
  - client_id
  - start_at
  - end_at
  - status (hold/confirmed/canceled/done)
  - price_quote
  - discount_applied (json)
  - miniapp_payload (json, nullable)
  - created_at

### 6.5 Payments (этап 3)
- payments:
  - id
  - appointment_id
  - provider
  - external_id (unique)
  - status (pending/paid/failed/refunded)
  - amount
  - currency
  - created_at
  - updated_at

### 6.6 Audit (рекомендуется)
- audit_log:
  - id
  - actor_telegram_user_id
  - action
  - payload_json
  - created_at


## 7. Календарь и правила бронирования
- слоты генерируются из schedule_rules;
- затем применяются exceptions (off/extra/block);
- статус hold (10–15 минут) ставится при выборе слота (или перед оплатой на этапе 3);
- confirmed — после подтверждения (и/или оплаты депозита на этапе 3);
- защита от гонок: транзакции + уникальные ограничения на пересечение времени.


## 8. Платежи (этап 3) — общий интерфейс
PaymentProvider:
- create_invoice(appointment_id, amount, meta) -> {pay_url, external_id}
- parse_webhook(request) -> {external_id, status, paid_amount}
- verify_signature(request) -> bool
Требования:
- webhook идемпотентен (повторный вызов не ломает состояние).


## 9. Наблюдаемость и безопасность
- логирование структурно, без секретов и без лишнего PII;
- allowlist на админку по telegram_user_id;
- rate limit на команды записи/оплаты/создания заявок;
- таймауты/ретраи на внешние сервисы;
- валидация входных данных (включая файлы);
- безопасное хранение конфигов и ключей (env).


## 10. Definition of Done для любой фичи
Фича готова, если:
- реализована логика + обработка ошибок;
- есть тесты на основной и крайние сценарии;
- обновлена документация (если менялся интерфейс/API/модель);
- CI зелёный (format/lint/tests);
- пройден security checklist.
