# AI Task Specification — Responsibilities, Rules, Checklists

## 1. Разграничение ответственности
### 1.1 Разработчик (человек) — accountable
- финальные архитектурные решения;
- реализация core-фич и мердж;
- релизы и прод-настройка;
- ответственность за платежи и безопасность.

### 1.2 ИИ — responsible за качество и поддержку
ИИ делает по умолчанию:
- тесты (unit/integration), фикстуры, мок-провайдеры;
- документацию (README, SPEC, схемы, DoD);
- ревью (качество, крайние случаи, читаемость);
- оптимизацию (узкие места, async, кеширование);
- security check + статический анализ + предложения патчей.

ИИ НЕ должен:
- добавлять новые зависимости “на всякий случай”;
- менять требования и UX без явной задачи;
- делать крупные рефакторы без необходимости;
- добавлять лишние сущности/таблицы, не описанные в техспеке.


## 2. Формат работы ИИ
### 2.1 Входная задача (что должен дать разработчик)
- контекст: какая фича/баг, где в коде;
- ограничения: что нельзя менять;
- Definition of Done.

### 2.2 Выход от ИИ (строгий формат)
1) Что сделано (кратко)
2) Изменённые файлы (список)
3) Тесты: какие добавлены/обновлены + команды запуска
4) Security checklist: пройденные пункты
5) Риски/заметки (если есть)

Если ИИ генерирует код:
- указывать пути файлов;
- маленькими порциями (одна задача = один логический PR);
- без лишних зависимостей.


## 3. Архитектурные правила (обязательные)
- handlers тонкие: нет бизнес-логики;
- бизнес-логика в core/services;
- доступ к БД через core/repositories;
- конфиги/секреты только через env;
- никаких sleep в async-сценариях;
- таймауты и ретраи на внешние запросы;
- идемпотентность webhooks (этап 3).


## 4. Тест-стратегия (что ИИ обязан делать)
### 4.1 Unit tests (обязательно)
- pricing:
  - расчёт цены по правилам (body_part/size/complexity)
  - применение коэффициентов
  - применение скидок (percent/fixed, промокод, приоритет)
- schedule:
  - генерация слотов из правил
  - применение исключений (off/extra/block)
  - конфликт записей (пересечение времени)
- booking:
  - переходы статусов hold → confirmed → canceled/done
  - TTL для hold (если реализовано)

### 4.2 Integration tests (по необходимости)
- репозитории (Postgres) с транзакционным rollback;
- endpoints API (если уже есть FastAPI часть);
- webhook платежей (этап 3): верификация подписи, идемпотентность.

### 4.3 Требование к тестам
- тесты должны быть быстрыми и стабильными;
- фикстуры не должны зависеть от внешнего интернета;
- критичная логика — покрыта edge cases.


## 5. Security checklist (ИИ обязан прикладывать к каждому PR)
- [ ] в коде/логах нет токенов/ключей/PII
- [ ] админ доступ только allowlist telegram_user_id
- [ ] входные данные валидируются (включая файлы)
- [ ] rate limit/антиспам для заявки/записи/оплаты
- [ ] таймауты/ретраи на внешних вызовах
- [ ] защита от гонок при бронировании (транзакции/уникальные ограничения)
- [ ] webhook идемпотентен и валидирует подпись (этап 3)
- [ ] минимизация хранения персональных данных


## 6. Документация (что ИИ должен обновлять)
Если меняется:
- API/пэйлоады/эндпоинты
- модель данных/миграции
- UX состояния/меню/кнопки
- правила прайсинга/скидок/расписания/оплаты

ИИ обновляет:
- TECHNICAL_SPEC.md (при изменениях требований/архитектуры)
- README.md (как запускать/тестировать)
- (опционально) CHANGELOG.md для заметных изменений


## 7. Оптимизация (гайд)
- избегать N+1 запросов;
- кэшировать неизменяемые сущности (стили/работы/прайс) по TTL;
- не хранить тяжёлые объекты в FSM (хранить ключи, данные — в БД);
- ограничивать параллелизм тяжёлых операций;
- не плодить фоновые таски без необходимости.


## 8. Ревью-чеклист ИИ
- читаемость (короткие функции, говорящие названия);
- покрытие тестами (основной путь + edge cases);
- ошибки и таймауты обработаны;
- совместимость не ломается;
- требования техспеки соблюдены.
