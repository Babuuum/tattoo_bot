# AGENTS.md — Project Working Agreement (Telegram Bot + FastAPI + Postgres + Redis)

Этот файл — локальные правила для Codex CLI в этом репозитории. Он дополняет глобальные правила из ~/.codex/AGENTS.md.

## Роли (как мы работаем)
- **Architect (план/решения)**: уточняет требования, предлагает архитектуру, формирует промпт исполнителю. Не вносит правки в код без явного разрешения.
- **Implementer (исполнитель)**: вносит изменения в репозиторий, не меняет требования/архитектуру без запроса.
- **Reviewer (ревьюер)**: делает review по диффу, не трогает рабочее дерево.
- **QA (качество)**: тесты/линтеры/форматтеры/pre-commit, чинит до зелёного.
- **Security (безопасность)**: проверяет секреты/валидацию/вебхуки/гонки, предлагает патчи и тесты.
- **Docs (доки)**: README/спеки/команды запуска.

## Глобальные ограничения проекта (обязательные)
- Никаких новых зависимостей без явного запроса.
- Никаких “рефакторов ради красоты”.
- Хендлеры тонкие: I/O и роутинг. Бизнес-логика в core/services, доступ к БД в core/repositories.
- Секреты никогда не логировать и не коммитить.
- Любое изменение должно сопровождаться проверками качества (см. ниже).

## Когда задавать вопросы (обязательно)
Если в задаче не хватает критичных данных — **сначала спросить**, не додумывать:
- какая версия библиотек/фреймворков (aiogram v3 и т.д.)
- какой режим запуска (dev/prod)
- какие файлы/интерфейсы нельзя менять
- какие требования к совместимости/миграциям

## Что обязано быть в ответе агента после работы
1) Кратко: что сделано
2) Список изменённых файлов
3) Как проверить (команды)
4) Риски/edge cases
5) Если вносились изменения в требования/архитектуру — указать это явно (обычно запрещено)

## Quality Gate (всегда после правок)
Выполнить и довести до “зелёного”:
- `pytest`
- `ruff check .`
- `black .`
- `pre-commit run -a` (если настроен)

Дополнительно (smoke, по возможности): проверить Docker-сборку/запуск и обязательно всё остановить:
- `docker compose up -d --build`
- `curl -f http://localhost:8000/health`
- `docker compose logs --no-color --tail=200` (если есть проблемы)
- `docker compose down -v --remove-orphans`

## Документация
Если менялись:
- env переменные
- команды запуска
- структура проекта
- поведение dev/prod
то обновить:
- `README.md`
- `TECHNICAL_SPEC.md` и/или `AI_TASK_SPEC.md` (в корне проекта)

## Формат работы по задачам (рекомендовано)
- 1 задача = 1 логический PR/коммит
- Минимальный дифф
- Сначала tests/linters green, потом финальный отчёт
